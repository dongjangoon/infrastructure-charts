apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-memory-intensive-script
  namespace: default
data:
  memory-intensive-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    export let errorRate = new Rate('errors');

    // ë©”ëª¨ë¦¬ ì§‘ì•½ì  í…ŒìŠ¤íŠ¸ - ë©”ëª¨ë¦¬ HPA ìŠ¤ì¼€ì¼ë§ ìœ ë°œ
    export let options = {
      stages: [
        // ì›Œë°ì—…: 1ë¶„ ë™ì•ˆ 0 -> 30 ì‚¬ìš©ì
        { duration: '1m', target: 30 },
        // 1ë‹¨ê³„: 3ë¶„ ë™ì•ˆ 30 -> 80 ì‚¬ìš©ì (ë©”ëª¨ë¦¬ 40-60%)
        { duration: '3m', target: 80 },
        // 2ë‹¨ê³„: 5ë¶„ ë™ì•ˆ 80 -> 150 ì‚¬ìš©ì (ë©”ëª¨ë¦¬ 60-80%, HPA íŠ¸ë¦¬ê±°)
        { duration: '5m', target: 150 },
        // 3ë‹¨ê³„: 3ë¶„ ë™ì•ˆ 150 -> 250 ì‚¬ìš©ì (ë©”ëª¨ë¦¬ ìŠ¤íŠ¸ë ˆìŠ¤)
        { duration: '3m', target: 250 },
        // ê³ ë¶€í•˜ ìœ ì§€: 10ë¶„ ë™ì•ˆ 250 ì‚¬ìš©ì
        { duration: '10m', target: 250 },
        // ì ì§„ì  ê°ì†Œ: 5ë¶„ ë™ì•ˆ 250 -> 50 ì‚¬ìš©ì
        { duration: '5m', target: 50 },
        // ì¿¨ë‹¤ìš´: 3ë¶„ ë™ì•ˆ 50 -> 0 ì‚¬ìš©ì
        { duration: '3m', target: 0 },
      ],
      thresholds: {
        http_req_duration: ['p(95)<5000'],
        errors: ['rate<0.15'],
        http_reqs: ['rate>20'],
      },
    };

    const BASE_URL = 'http://test-app-service.default.svc.cluster.local';

    // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì„ ëŠ˜ë¦¬ê¸° ìœ„í•œ í° ë°ì´í„° ìƒì„±
    let largeDataArray = [];
    let sessionStorage = new Map();

    export default function () {
      // í° ì‘ë‹µ ë°ì´í„°ë¥¼ ìš”ì²­í•˜ì—¬ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€
      let response = http.get(`${BASE_URL}/`, {
        headers: {
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Encoding': 'gzip, deflate, br',
          'User-Agent': 'Mozilla/5.0 (compatible; k6-memory-test)',
        }
      });

      // ì‘ë‹µ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ì¶•ì  (ë©”ëª¨ë¦¬ ë¦¬í¬ ì‹œë®¬ë ˆì´ì…˜)
      if (response.body) {
        largeDataArray.push({
          timestamp: Date.now(),
          responseBody: response.body,
          headers: JSON.stringify(response.headers),
          metrics: {
            duration: response.timings.duration,
            size: response.body.length
          }
        });

        // ì„¸ì…˜ ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜ (ì‚¬ìš©ìë³„ ë©”ëª¨ë¦¬ ì‚¬ìš©)
        let userId = `user_${__VU}_${__ITER}`;
        sessionStorage.set(userId, {
          requests: (sessionStorage.get(userId)?.requests || 0) + 1,
          data: response.body.substring(0, 1000), // 1KB ì •ë„ ì €ì¥
          history: largeDataArray.slice(-10) // ìµœê·¼ 10ê°œ ìš”ì²­ ê¸°ë¡
        });
      }

      let result = check(response, {
        'status is 200': (r) => r.status === 200,
        'response size > 0': (r) => r.body && r.body.length > 0,
        'memory data stored': () => largeDataArray.length > 0,
      });

      errorRate.add(!result);

      // ì—¬ëŸ¬ ë™ì‹œ ìš”ì²­ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¶”ê°€ ì¦ê°€
      let requests = [];
      for (let i = 0; i < 5; i++) {
        requests.push(http.get(`${BASE_URL}/heavy-data-${i}`, {
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        }));
      }

      // ê° ì‘ë‹µì„ ë©”ëª¨ë¦¬ì— ì €ì¥
      requests.forEach((req, index) => {
        if (req.body) {
          largeDataArray.push({
            requestId: `batch_${index}_${__VU}_${__ITER}`,
            data: req.body,
            timestamp: Date.now()
          });
        }
      });

      // í° JSON ê°ì²´ ìƒì„± (ì¶”ê°€ ë©”ëª¨ë¦¬ ì‚¬ìš©)
      let memoryHog = {
        timestamp: Date.now(),
        virtualUser: __VU,
        iteration: __ITER,
        largeArray: new Array(1000).fill(0).map((_, i) => ({
          id: i,
          data: `memory_consuming_data_${i}_${Math.random()}`,
          nested: {
            level1: new Array(50).fill('data'),
            level2: new Array(50).fill('more_data')
          }
        })),
        sessionInfo: Object.fromEntries(sessionStorage)
      };

      // ë©”ëª¨ë¦¬ ì •ë¦¬ (ê°€ë”ì”©ë§Œ ì‹¤í–‰í•˜ì—¬ ë©”ëª¨ë¦¬ ì••ë°• ìœ ì§€)
      if (__ITER % 50 === 0) {
        largeDataArray = largeDataArray.slice(-100); // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
        // ì„¸ì…˜ ë°ì´í„° ì¼ë¶€ ì •ë¦¬
        if (sessionStorage.size > 1000) {
          let keysToDelete = Array.from(sessionStorage.keys()).slice(0, 200);
          keysToDelete.forEach(key => sessionStorage.delete(key));
        }
      }

      // ì§§ì€ ëŒ€ê¸° ì‹œê°„ (ë©”ëª¨ë¦¬ ì••ë°• ì§€ì†)
      sleep(Math.random() * 1 + 0.5);
    }

    export function handleSummary(data) {
      return {
        'memory-intensive-test-summary.json': JSON.stringify(data),
        stdout: `
    === k6 ë©”ëª¨ë¦¬ ì§‘ì•½ì  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ===
    ğŸ§  ìµœëŒ€ ë™ì‹œ ì‚¬ìš©ì: 250ëª… (ë©”ëª¨ë¦¬ ì¤‘ì‹¬)
    ğŸ“Š ì´ ìš”ì²­ ìˆ˜: ${data.metrics.http_reqs.count}
    â±ï¸  í‰ê·  ì‘ë‹µ ì‹œê°„: ${data.metrics.http_req_duration.avg.toFixed(2)}ms
    ğŸ“ˆ 95 í¼ì„¼íƒ€ì¼: ${data.metrics['http_req_duration{percentile:95}'].value.toFixed(2)}ms
    âŒ ì—ëŸ¬ìœ¨: ${(data.metrics.errors.rate * 100).toFixed(2)}%
    ğŸš€ ì´ˆë‹¹ í‰ê·  ìš”ì²­: ${data.metrics.http_reqs.rate.toFixed(2)}

    === ë©”ëª¨ë¦¬ HPA ëª¨ë‹ˆí„°ë§ ===
    kubectl get hpa test-app-hpa -w
    kubectl top pods -l app=test-app --containers
    kubectl describe pods -l app=test-app | grep -A 5 -B 5 memory
        `,
      };
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: k6-memory-intensive-test
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: k6
        image: grafana/k6:latest
        command: ["k6", "run", "/scripts/memory-intensive-test.js"]
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        volumeMounts:
        - name: k6-script-volume
          mountPath: /scripts
      volumes:
      - name: k6-script-volume
        configMap:
          name: k6-memory-intensive-script
      restartPolicy: Never
  backoffLimit: 1