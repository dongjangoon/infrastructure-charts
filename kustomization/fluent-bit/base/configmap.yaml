apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: logging
  labels:
    app.kubernetes.io/name: fluentbit
data:
  fluent-bit.conf: |
    [SERVICE]
        Daemon off                        # 백그라운드 데몬 모드 비활성화 (컨테이너 환경)
        Flush 5                          # 출력 플러그인으로 데이터 전송 주기 (초)
        Log_Level warn                   # 로그 레벨 (trace|debug|info|warn|error|off)
        Parsers_File parsers.conf        # 파서 설정 파일 경로
        storage.path /var/fluent-bit/state/flb-storage/  # 버퍼링을 위한 스토리지 경로
        storage.sync normal              # 스토리지 동기화 모드 (normal|full)
        storage.checksum off             # 체크섬 검증 비활성화 (성능 향상)
        storage.backlog.mem_limit 5M     # 백로그 메모리 제한
        HTTP_Server On                   # HTTP 모니터링 서버 활성화
        HTTP_Listen 0.0.0.0             # HTTP 서버 바인딩 주소
        HTTP_Port 2020                   # HTTP 서버 포트 (/api/v1/metrics 엔드포인트)
        Health_Check On                  # 헬스체크 엔드포인트 활성화

    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        Parser cri
        DB /var/fluent-bit/state/flb_log.db
        Tag_Regex ^/var/log/containers/(?<pod>[^_]+)_(?<namespace>[^_]+)_(?<container>[^-]+)-(?<container_id>.+)\.log$
        Tag kube.<namespace>
        Path_Key filepath
        Mem_Buf_Limit 10MB
        Skip_Long_Lines On
        Refresh_Interval 5

    # 클러스터명 추가
    [FILTER]
        Name modify                      # 레코드 필드 수정 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭
        Add cluster_name CLUSTER_NAME_PLACEHOLDER  # 클러스터 식별을 위한 필드 추가

    # 파일 경로에서 파드명과 네임스페이스 추출
    [FILTER]
        Name parser                      # 파서 필터 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭
        Key_Name filepath                # 파싱할 필드명 (컨테이너 로그 파일 경로)
        Parser container_path_parser     # 사용할 파서명 (parsers.conf에 정의)
        Reserve_Data On                  # 원본 데이터 보존

    # message 필드의 JSON 파싱 시도 (Java 애플리케이션 로그)
    [FILTER]
        Name parser                      # 파서 필터 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭
        Key_Name message                 # 파싱할 필드명 (로그 메시지)
        Parser java_json                 # JSON 형태의 Java 로그 파서
        Reserve_Data On                  # 원본 데이터 보존
        Preserve_Key On                  # 원본 키 유지 (파싱 실패시 원본 message 보존)

    # 환경 정보 추출 및 로그 레벨 감지
    [FILTER]
        Name lua                         # Lua 스크립트 필터 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭
        Script /fluent-bit/scripts/environment_detector.lua  # 환경 감지 스크립트 경로
        Call extract_environment         # 호출할 Lua 함수명

    # Java JSON 로그 후처리 및 필드 정규화
    [FILTER]
        Name lua                         # Lua 스크립트 필터 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭
        Script /fluent-bit/scripts/java_log_processor.lua  # Java 로그 처리 스크립트 경로
        Call process_java_log            # 호출할 Lua 함수명

    # 불필요한 필드 제거 및 정리
    [FILTER]
        Name modify                      # 레코드 필드 수정 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭
        Remove filepath                  # 파일 경로 필드 제거 (이미 파싱 완료)
        Remove container_id              # 컨테이너 ID 제거 (불필요)
        Remove logtag                    # 로그 태그 제거 (CRI 파서에서 생성)
        Remove log_source                # 로그 소스 제거 (불필요)

    # Java 멀티라인 로그 처리 (Stack Trace)
    [FILTER]
        Name multiline                   # 멀티라인 처리 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭
        Multiline.Key_Content message    # 멀티라인 처리할 필드명
        Multiline.Parser java_multiline  # 사용할 멀티라인 파서 (스택트레이스 병합)

    # -------------------------
    # Output: 애플리케이션 로그 (클러스터별)
    # -------------------------
    [OUTPUT]
        Name opensearch                  # OpenSearch 출력 플러그인
        Match kube.*                     # kube.로 시작하는 모든 태그 매칭 (Match_Regex * 오류 수정)
        Host HOST_PLACEHOLDER            # OpenSearch 호스트 주소
        Port 9200                        # OpenSearch HTTP 포트
        Index INDEX_PLACEHOLDER          # 기본 인덱스명 (Logstash_Format 사용시 무시됨)
        Include_Tag_Key true             # 태그를 필드로 포함
        Tag_Key @svc_name               # 태그가 저장될 필드명 (서비스 식별용)
        Suppress_Type_Name On           # _type 필드 생성 억제 (OpenSearch 2.x 호환성)
        Logstash_Format On              # Logstash 형태 인덱스 포맷 활성화
        Logstash_Prefix INDEX_PLACEHOLDER  # 인덱스 접두사 (날짜와 조합: prefix-YYYY.MM.DD)
        Logstash_DateFormat %Y.%m.%d    # 인덱스 날짜 포맷 (연.월.일)
        Time_Key @timestamp             # 타임스탬프 필드명
        Retry_Limit 5                   # 전송 실패시 재시도 횟수
        tls off                         # TLS/SSL 비활성화

  parsers.conf: |
    # CRI(Container Runtime Interface) 로그 파서
    [PARSER]
        Name cri                         # 파서 이름 (INPUT에서 참조)
        Format regex                     # 정규식 파서 형태
        Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$  # CRI 로그 형식 파싱
        Time_Key time                    # 타임스탬프 필드명
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z  # ISO8601 시간 형식

    # 컨테이너 파일 경로 파서 (파드/네임스페이스/컨테이너명 추출)
    [PARSER]
        Name container_path_parser       # 파서 이름
        Format regex                     # 정규식 파서 형태
        Regex ^/var/log/containers/(?<pod_name>[^_]+)_(?<namespace>[^_]+)_(?<container_name>[^-]+)-(?<container_id>.+)\.log$  # 파일명에서 k8s 정보 추출

    # Java JSON 로그 파서
    [PARSER]
        Name java_json                   # 파서 이름
        Format json                      # JSON 파서 형태
        Time_Key @timestamp             # JSON 내 타임스탬프 필드명
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z  # ISO8601 시간 형식
        Time_Keep On                    # 원본 시간 필드 유지

    # Java 일반 멀티라인 파서 (날짜로 시작하는 로그)
    [MULTILINE_PARSER]
        name java                        # 멀티라인 파서 이름
        type regex                       # 정규식 기반 멀티라인
        flush_timeout 1000              # 멀티라인 완성 대기 시간 (ms)
        rule "start_state" "/(\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2}[\.,]\d{3})/" "cont"  # 새 로그 시작 패턴
        rule "cont" "/^(?!\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2})/" "cont"  # 연속 라인 패턴

    # Java Exception/Stack Trace 멀티라인 파서
    [MULTILINE_PARSER]
        name java_multiline              # 멀티라인 파서 이름
        type regex                       # 정규식 기반 멀티라인
        flush_timeout 1000              # 멀티라인 완성 대기 시간 (ms)
        rule "start_state" "/^(\d{4}-\d{2}-\d{2}|.*Exception|.*Error|\tat |Caused by:)/" "cont"  # Exception/Error 시작 패턴
        rule "cont" "/^(\s+at\s|Caused by:|.*Exception|.*Error|\s+\.\.\.|\t)/" "cont"  # Stack trace 연속 패턴