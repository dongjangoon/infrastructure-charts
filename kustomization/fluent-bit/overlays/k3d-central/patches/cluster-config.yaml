apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: logging
  labels:
    app.kubernetes.io/name: fluentbit
data:
  fluent-bit.conf: |
    [SERVICE]
        Daemon off
        Flush 5
        Log_Level warn
        Parsers_File parsers.conf
        storage.path /var/fluent-bit/state/flb-storage/
        storage.sync normal
        storage.checksum off
        storage.backlog.mem_limit 5M
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port 2020
        Health_Check On

    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        Parser cri
        DB /var/fluent-bit/state/flb_log.db
        Tag_Regex ^/var/log/containers/(?<pod>[^_]+)_(?<namespace>[^_]+)_(?<container>[^-]+)-(?<container_id>.+)\.log$
        Tag kube.<namespace>
        Path_Key filepath
        Mem_Buf_Limit 10MB
        Skip_Long_Lines On
        Refresh_Interval 5

    [FILTER]
        Name modify
        Match kube.*
        Add cluster_name k3d-central

    [FILTER]
        Name parser
        Match kube.*
        Key_Name filepath
        Parser container_path_parser
        Reserve_Data On

    [FILTER]
        Name parser
        Match kube.*
        Key_Name message
        Parser java_json
        Reserve_Data On
        Preserve_Key On

    # 환경 정보 추출 및 로그 레벨 감지
    [FILTER]
        Name lua                    
        Match kube.*                  
        Script /fluent-bit/scripts/environment_detector.lua 
        Call extract_environment       

    # Java JSON 로그 후처리 및 필드 정규화
    [FILTER]
        Name lua                 
        Match kube.*                
        Script /fluent-bit/scripts/java_log_processor.lua  
        Call process_java_log        

    [FILTER]
        Name modify
        Match kube.*
        Remove filepath
        Remove container_id
        Remove logtag
        Remove log_source

    [FILTER]
        Name multiline
        Match kube.*
        Multiline.Key_Content message
        Multiline.Parser java_multiline

    [OUTPUT]
        Name opensearch
        Match kube.*
        Host opensearch-cluster-master
        Port 9200
        Index k3d-central
        Include_Tag_Key true
        Tag_Key @svc_name
        Suppress_Type_Name On
        Logstash_Format On
        Logstash_Prefix k3d-central
        Logstash_DateFormat %Y.%m.%d
        Time_Key @timestamp
        Retry_Limit 5
        tls off

  parsers.conf: |
    [PARSER]
        Name cri
        Format regex
        Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name container_path_parser
        Format regex
        Regex ^/var/log/containers/(?<pod_name>[^_]+)_(?<namespace>[^_]+)_(?<container_name>[^-]+)-(?<container_id>.+)\.log$

    [PARSER]
        Name java_json
        Format json
        Time_Key @timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep On

    [MULTILINE_PARSER]
        name java
        type regex
        flush_timeout 1000
        rule "start_state" "/(\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2}[\.,]\d{3})/" "cont"
        rule "cont" "/^(?!\d{4}-\d{1,2}-\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2})/" "cont"

    [MULTILINE_PARSER]
        name java_multiline
        type regex
        flush_timeout 1000
        rule "start_state" "/^(\d{4}-\d{2}-\d{2}|.*Exception|.*Error|\tat |Caused by:)/" "cont"
        rule "cont" "/^(\s+at\s|Caused by:|.*Exception|.*Error|\s+\.\.\.|\t)/" "cont"