apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-extreme-stress-script
  namespace: default
data:
  extreme-stress-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    export let errorRate = new Rate('errors');

    // ê·¹í•œ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ - ë…¸ë“œ ìŠ¤ì¼€ì¼ë§ + ì‹œìŠ¤í…œ í•œê³„ í…ŒìŠ¤íŠ¸
    export let options = {
      stages: [
        // ê¸‰ì† ì¦ê°€: 2ë¶„ ë™ì•ˆ 0 -> 200 ì‚¬ìš©ì
        { duration: '2m', target: 200 },
        // 1ì°¨ ìŠ¤íŠ¸ë ˆìŠ¤: 3ë¶„ ë™ì•ˆ 200 -> 500 ì‚¬ìš©ì
        { duration: '3m', target: 500 },
        // 2ì°¨ ìŠ¤íŠ¸ë ˆìŠ¤: 5ë¶„ ë™ì•ˆ 500 -> 1000 ì‚¬ìš©ì (ë…¸ë“œ ìŠ¤ì¼€ì¼ë§ ê°•ì œ)
        { duration: '5m', target: 1000 },
        // ê·¹í•œ ë¶€í•˜: 3ë¶„ ë™ì•ˆ 1000 -> 1500 ì‚¬ìš©ì
        { duration: '3m', target: 1500 },
        // ìµœëŒ€ ë¶€í•˜ ìœ ì§€: 8ë¶„ ë™ì•ˆ 1500 ì‚¬ìš©ì ì§€ì†
        { duration: '8m', target: 1500 },
        // ë©”ê°€ ìŠ¤íŒŒì´í¬: 1ë¶„ ë™ì•ˆ 1500 -> 2000 ì‚¬ìš©ì (ì‹œìŠ¤í…œ í•œê³„ í…ŒìŠ¤íŠ¸)
        { duration: '1m', target: 2000 },
        // ìŠ¤íŒŒì´í¬ ìœ ì§€: 2ë¶„ ë™ì•ˆ 2000 ì‚¬ìš©ì
        { duration: '2m', target: 2000 },
        // ê¸‰ì† ê°ì†Œ: 3ë¶„ ë™ì•ˆ 2000 -> 500 ì‚¬ìš©ì
        { duration: '3m', target: 500 },
        // ì •ìƒí™”: 5ë¶„ ë™ì•ˆ 500 -> 0 ì‚¬ìš©ì
        { duration: '5m', target: 0 },
      ],
      thresholds: {
        http_req_duration: ['p(95)<10000'], // ì‘ë‹µì‹œê°„ 10ì´ˆ ì´í•˜
        errors: ['rate<0.3'], // ì—ëŸ¬ìœ¨ 30% ì´í•˜ (ê·¹í•œ ìƒí™© ê³ ë ¤)
        http_reqs: ['rate>100'], // ì´ˆë‹¹ 100 ìš”ì²­ ì´ìƒ
      },
    };

    const BASE_URL = 'http://test-app-service.default.svc.cluster.local';

    export default function () {
      // ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ ìƒì„±í•˜ì—¬ ë¶€í•˜ ê·¹ëŒ€í™”
      let responses = [];
      
      // ë³‘ë ¬ ìš”ì²­ìœ¼ë¡œ CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê¸‰ì¦
      for (let i = 0; i < 3; i++) {
        responses.push(http.get(`${BASE_URL}/`));
      }

      // ì‘ë‹µ ê²€ì¦
      responses.forEach((response, index) => {
        let result = check(response, {
          [`request_${index}_status_200`]: (r) => r.status === 200,
          [`request_${index}_response_time`]: (r) => r.timings.duration < 10000,
        });
        errorRate.add(!result);
      });

      // ì¶”ê°€ ë¶€í•˜ë¥¼ ìœ„í•œ ë”ë¯¸ ìš”ì²­ë“¤
      const heavyEndpoints = [
        '/',
        '/heavy-computation',
        '/large-data',
        '/api/users',
        '/api/products'
      ];

      // ëœë¤í•˜ê²Œ ë¬´ê±°ìš´ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
      for (let i = 0; i < 5; i++) {
        let endpoint = heavyEndpoints[Math.floor(Math.random() * heavyEndpoints.length)];
        http.get(`${BASE_URL}${endpoint}`);
      }

      // ë§¤ìš° ì§§ì€ ëŒ€ê¸° ì‹œê°„ìœ¼ë¡œ ê·¹í•œ RPS ë‹¬ì„±
      sleep(Math.random() * 0.5 + 0.1); // 0.1-0.6ì´ˆ
    }

    export function handleSummary(data) {
      return {
        'extreme-stress-test-summary.json': JSON.stringify(data),
        stdout: `
    === k6 ê·¹í•œ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ===
    âš ï¸  ìµœëŒ€ ë™ì‹œ ì‚¬ìš©ì: 2000ëª… (ê·¹í•œ í…ŒìŠ¤íŠ¸)
    ğŸ“Š ì´ ìš”ì²­ ìˆ˜: ${data.metrics.http_reqs.count}
    â±ï¸  í‰ê·  ì‘ë‹µ ì‹œê°„: ${data.metrics.http_req_duration.avg.toFixed(2)}ms
    ğŸ“ˆ 95 í¼ì„¼íƒ€ì¼: ${data.metrics['http_req_duration{percentile:95}'].value.toFixed(2)}ms
    âŒ ì—ëŸ¬ìœ¨: ${(data.metrics.errors.rate * 100).toFixed(2)}%
    ğŸš€ ì´ˆë‹¹ í‰ê·  ìš”ì²­: ${data.metrics.http_reqs.rate.toFixed(2)}

    === ëª¨ë‹ˆí„°ë§ ëª…ë ¹ì–´ ===
    kubectl get hpa test-app-hpa -w
    kubectl get pods -l app=test-app -w
    kubectl top nodes
    kubectl top pods -l app=test-app
    kubectl get events --sort-by=.metadata.creationTimestamp
        `,
      };
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: k6-extreme-stress-test
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: k6
        image: grafana/k6:latest
        command: ["k6", "run", "/scripts/extreme-stress-test.js"]
        resources:
          requests:
            cpu: 1000m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi
        volumeMounts:
        - name: k6-script-volume
          mountPath: /scripts
      volumes:
      - name: k6-script-volume
        configMap:
          name: k6-extreme-stress-script
      restartPolicy: Never
  backoffLimit: 1